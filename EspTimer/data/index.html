<!DOCTYPE html5>
<html>
    <head>
        <title>%TITLE%</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    
<body onload="OnLoad()">
<h1 id="TITLE">%TITLE%</h1>

<div style = "text-align:center;">
    <canvas id ="clk" width="300" height="300" style="position:relative; margin:auto">
    </canvas><br>
    <a id="TEMPERATURE"><strong>%TEMPERATURE%</strong></a><br>
    <b id="SUN"></b>
</div>
<br/><br/>
<form>
    <label class="Large" for="START_AT" id="START_AT_L" >Start at:</label>
    <input class="Large" type="time" id="START_AT" >
</form>

<form>
    <label class="Large" for="STOP_AT"  id="STOP_AT_L" >End at :</label>
    <input class="Large" type="time" id="STOP_AT" height="30">
</form>
  
<div style = "text-align:center;">
    <a id="START">  <button id="START_B" class="button button_GREEN" style="margin:10px;" onclick="OnSTART()" hidden>START</button></a>
    <a id="STOP">   <button id="STOP_B"  class="button button_RED"   style="margin:10px;" onclick="OnSTOP()"  hidden>STOP</button></a><br>
    <a id="DEBUG_VALUE"></a>
    <P id="ERROR" style="color:red; font-size:20px;"><strong></strong></p>

</div>

<script>
    var clk;
    var ctx;
    var radius;
    var t;
    var cx;
    var cy;
    var started;
    var update_start_end = true;
    var sunRise;
    var sunSet;

    function send_post(url) {
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", url, true);
        xhttp.send();
        refreshData();
    }

    function trace(msg) {
        alert(msg);
    }

    function d2s(d) {
        return Math.trunc(d.getTime() / 1000);
    }

    function s2d(s) {
        return new Date(s * 1000);
    }

    Date.prototype.stdTimezoneOffset = function() {
        var jan = new Date(this.getFullYear(), 0, 1);
        var jul = new Date(this.getFullYear(), 6, 1);
        return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    }

    Date.prototype.dst = function() {
        return this.getTimezoneOffset() < this.stdTimezoneOffset();
    }

    function offsetSeconds(d)   {
        return d.getTimezoneOffset() * 60;
    }

    function FixTime(d)  {
        return d2s(d) - offsetSeconds(d);
    }

    function JavaTime(s)  {
        d = new Date();
        s += offsetSeconds(d);

        return s2d(s);
    }

    var seconds_counter = 0;
    var force_refresh = false;

    var on_time = new Date();
    var off_time = new Date();

    var default_seconds;

    var start_seconds = 0;
    var end_seconds = 0;
    var default_seconds = 0;

    function OnLoad() {
        document.getElementById("START_AT_L").style.display = "none";
        document.getElementById("START_AT").style.display = "none";
        //document.getElementById("START_B").style.display = "none";

        document.getElementById("STOP_AT_L").style.display = "none";
        document.getElementById("STOP_AT").style.display = "none";
        //document.getElementById("STOP_B").style.display = "none";

        clk = document.getElementById("clk");
        ctx = clk.getContext("2d");

        cx = clk.width / 2;
        cy = clk.height / 2;
        radius = cy - 10;

        ctx.translate(cx, cy);

        radius = radius * 0.90;

        getSun();
        refreshNow();

        setInterval(refresh, 1000);
    }

    function refresh()
    {
        refreshData();
        drawClock();
    }

    function refreshNow()
    {
        force_refresh = true;
        refresh();
        force_refresh = false;
    }

    function roundSecondsToMinutes(n)
    {
        return n - (n % 60);
    }   

    function roundToMinutes(t)
    {
        temp = new Date(t);
        temp.setSeconds(0);
        return temp;
    }   

    //var on_input = null;
    //var off_input = null;

    function setSun(text)  {
        //document.getElementById("DEBUG_VALUE").innerText = text;

        arr = text.split(";");
        sunRiseText = arr[0];
        sunSetText  = arr[1];
        sunRiseSeconds = parseInt(arr[2]);
        sunSetSeconds  = parseInt(arr[3]);

        sunRise = JavaTime(sunRiseSeconds);
        sunSet  = JavaTime(sunSetSeconds);

        var sun = sunRiseText + " - " + sunSetText;
        document.getElementById("SUN").innerText = sun;
    }

    function setData(text)  {
        arr = text.split(";");
        start_seconds = parseInt(arr[0]);
        end_seconds = parseInt(arr[1]);
        default_seconds = parseInt(arr[2]);

        now_seconds = d2s(new Date());
        
        prev_on  = d2s(on_time);
        prev_off = d2s(off_time);

        on_time = new Date();
        off_time = new Date();

        prev_started = started;

        if(!end_seconds)
        {
            started = false;

            on_time  = s2d(now_seconds);
            off_time = s2d(now_seconds + default_seconds);
        }
        else
        {
            if (start_seconds > 0)  started = false;
            else                    started = true;

            on_time  = s2d(now_seconds + start_seconds);
            off_time = s2d(now_seconds + end_seconds);
        }

        document.getElementById("STOP_AT_L").style.display = "inline";
        document.getElementById("STOP_AT").style.display = "inline";

        start_b = document.getElementById("START_B");
        stop_b  = document.getElementById("STOP_B");

        if(end_seconds) {
            start_b.innerText = "UPDATE";

            if(started)
                stop_b.innerText = "STOP";
            else
                stop_b.innerText = "CANCEL";
        }
        else    {
            start_b.innerText = "START";
        }

        if (started)
        {
            stop_b.style.display = "inline";

            document.getElementById("START_AT_L").style.display = "none";
            document.getElementById("START_AT").style.display = "none";
        }
        else            
        {
            if(end_seconds) stop_b.style.display = "inline";
            else            stop_b.style.display = "none";

            document.getElementById("START_AT_L").style.display = "inline";
            document.getElementById("START_AT").style.display = "inline";
        }

        if(prev_started && !started)
            update_start_end = true;

        if(update_start_end)
        {
            document.getElementById("START_AT").value = roundToMinutes(on_time).toLocaleTimeString('en-GB');
            document.getElementById("STOP_AT").value  = roundToMinutes(off_time).toLocaleTimeString('en-GB');

            update_start_end = false;
        }
    }

    function addDay(t)
    {
        retval = new Date(t);
        retval.setTime(retval.getTime() + 86400 * 1000);
        return retval;
    }

    function OnSTART() {
        const today = new Date();
        start_time  = new Date(today.toDateString() + ' ' + document.getElementById("START_AT").value);
        end_time    = new Date(today.toDateString() + ' ' + document.getElementById("STOP_AT").value);

        if(start_time < today)   {
            if(d2s(today) - d2s(start_time) >= 3600)    {
                start_time = addDay(start_time);
            } else {
                start_time = today;
            }
        }

        if(end_time < start_time)   {
            end_time = addDay(end_time);
        }

        on_seconds  = d2s(start_time) - d2s(today);
        off_seconds = d2s(end_time)   - d2s(today);

        max_hours = 15;

        if(on_seconds >= off_seconds ||
           off_seconds - on_seconds > max_hours * 3600)   {
            if(started)
                alert("'End at' time limited to " + max_hours + " hours!");
            else
                alert("'Start at' time must be before 'End at' time!");
            return;
        }

        request = "/h/start?on=" + on_seconds + "&off=" + off_seconds;

        send_post(request);
/*
        alert(start_time + "\n" + 
              end_time + "\n" +
              d2s(start_time) + "\n" +
              d2s(end_time) + "\n" +
              on_seconds + "\n" +
              off_seconds + "\n" +
              request);
*/
        refreshNow();              
    }

    function OnSTOP() {
        send_post("/h/stop");
        refreshNow();              
    }

    var connected;

    function getSun()
    {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                setSun(this.responseText);
                connected = true;
            } else {
                if(connected)
                {
                    //alert("Connection lost");
                    connected = false;
                }
            }
        }

        now = new Date();

        fix_seconds = FixTime(now);
        dst         = now.dst();

        request = "/h/now?now=" + fix_seconds + "&dst=" + dst;

        xhttp.open("GET", request, true);
        xhttp.send();
    }

    function refreshData()    {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                setData(this.responseText);
                connected = true;
            } else {
                if(connected)
                {
                    //alert("Connection lost");
                    connected = false;
                }
            }
        }

        now = new Date();
        
        if(force_refresh || seconds_counter == 0 || now.getSeconds() % 5 == 0) {
            xhttp.open("GET", "/h/data", true);
            xhttp.send();
        }

        seconds_counter += 1;
    }

    function drawClock() {
        t = new Date();

        drawFace();
        drawNumbers();
        drawTime();

        return;

        ctx.stroke();

        ctx.translate(0, 0);
    }

    function drawRedArk()    {
        if(on_time == null)
            return;
        
        if(!end_seconds)
            return;

        bh = on_time.getHours(); 
        bm = on_time.getMinutes();
        bs = on_time.getSeconds();

        eh = off_time.getHours(); 
        em = off_time.getMinutes();
        es = off_time.getSeconds();

        start_pos = getHourPosition(bh, bm, bs);
        end_pos   = getHourPosition(eh, em, es);

        rotate_90_degreees = Math.PI * 0.5;

        ctx.rotate(-rotate_90_degreees);
        ctx.moveTo(0, 0);

        ctx.arc(0, 0, radius * 0.95, 
                start_pos, end_pos);
        ctx.lineWidth=30;
        hold = ctx.fillStyle;
        
        if(started) ctx.fillStyle="red";
        else        ctx.fillStyle="orange";

        ctx.fill();
        ctx.fillStyle = hold;
        ctx.rotate(rotate_90_degreees);
    }

    function getHourPosition(hour, minute, second)   {
        retval = hour % 12;
        retval = (retval * Math.PI / 6) +
                 (minute * Math.PI / (6 * 60)) +
                 (second * Math.PI / (360 * 60));

        return retval;
    }

    function drawFace() {
        var grad;
        ctx.beginPath();
        ctx.arc(0, 0, radius, 0, 2 * Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();
        grad = ctx.createRadialGradient(0, 0, radius * 0.95, 0, 0, radius * 1.05);
        grad.addColorStop(0, '#333');
        grad.addColorStop(0.5, 'white');
        grad.addColorStop(1, '#333');
        ctx.strokeStyle = grad;
        ctx.lineWidth = radius * 0.1;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(0, 0, radius * 0.1, 0, 2 * Math.PI);
        ctx.fillStyle = '#333';
        ctx.fill();

        drawRedArk();
    }

    function drawNumbers() {
        var ang;
        var num;
        ctx.font = radius * 0.15 + "px arial";
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";
        for (num = 1; num < 13; num++) {
            ang = num * Math.PI / 6;
            ctx.rotate(ang);
            ctx.translate(0, -radius * 0.85);
            ctx.rotate(-ang);
            ctx.fillText(num.toString(), 0, 0);
            ctx.rotate(ang);
            ctx.translate(0, radius * 0.85);
            ctx.rotate(-ang);
        }
    }

    function drawTime() {
        var now = t;

        var hour = now.getHours();
        var minute = now.getMinutes();
        var second = now.getSeconds();
        //hour
        hour = hour % 12;
        hour = (hour * Math.PI / 6) +
               (minute * Math.PI / (6 * 60)) +
               (second * Math.PI / (360 * 60));
        drawHand(hour, radius * 0.5, radius * 0.07);
        //minute
        minute = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60));
        drawHand(minute, radius * 0.8, radius * 0.07);
        // second
        second = (second * Math.PI / 30);
        drawHand(second, radius * 0.9, radius * 0.02);
    }

    function drawHand(pos, length, width) {
        ctx.beginPath();
        ctx.lineWidth = width;
        ctx.lineCap = "round";
        ctx.moveTo(0, 0);
        ctx.rotate(pos);
        ctx.lineTo(0, -length);
        ctx.stroke();
        ctx.rotate(-pos);
    }

</script>

</body>
</html>